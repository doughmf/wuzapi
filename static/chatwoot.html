<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Chatwoot Config</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.css">
  <style>
      body { background-color: #f4f6f9; display: flex; justify-content: center; padding-top: 50px; }
      .main-container { width: 100%; max-width: 600px; }
  </style>
</head>
<body>

  <div class="main-container">
    <div class="ui raised segment">
      <h2 class="ui header center aligned">
        <i class="comments icon purple"></i>
        <div class="content">Chatwoot Integration</div>
      </h2>
      
      <div class="ui divider"></div>

      <form class="ui form" id="configForm">
        <div class="field">
            <label>Admin Token (Wuzapi)</label>
            <input type="password" id="wuzapi_token" placeholder="Seu Token de Admin">
        </div>

        <div class="field">
            <label>Chatwoot URL</label>
            <input type="text" id="cw_url" placeholder="https://app.seudominio.com">
        </div>

        <div class="field">
            <label>User Access Token (Chatwoot)</label>
            <input type="password" id="cw_token" placeholder="Token do Perfil do Usuário">
        </div>

        <div class="field">
            <label>Account ID</label>
            <input type="number" id="cw_account_id" placeholder="Ex: 1">
        </div>

        <div class="ui divider"></div>

        <div class="field">
             <label>Opções</label>
             <div class="ui two buttons">
                 <button type="button" class="ui teal button" onclick="autoCreate()">
                    <i class="magic icon"></i> Criar Caixa Automática
                </button>
                <button type="button" class="ui purple button" onclick="saveConfig()">
                    <i class="save icon"></i> Salvar Manualmente
                </button>
             </div>
        </div>
        
        <div class="field">
            <label>Inbox ID (Gerado)</label>
            <input type="text" id="cw_inbox_id" readonly placeholder="Será preenchido automaticamente">
        </div>

        <div class="ui error message" id="errorMessage"></div>
        <div class="ui success message" id="successMessage"></div>
        
        <button type="button" class="ui basic button fluid" onclick="window.location.href='/dashboard'">Voltar ao Dashboard</button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.4/dist/semantic.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const savedToken = localStorage.getItem('wuzapi_admin_token');
        if(savedToken) document.getElementById('wuzapi_token').value = savedToken;
        loadConfig();
    });

    async function autoCreate() {
        const form = $('#configForm');
        form.removeClass('error success loading');
        form.addClass('loading');
        
        const payload = {
            url: document.getElementById('cw_url').value,
            token: document.getElementById('cw_token').value,
            account_id: document.getElementById('cw_account_id').value,
            name: "Wuzapi Bot",
            wuzapi_url: window.location.origin
        };
        
        const adminToken = document.getElementById('wuzapi_token').value;

        try {
            const res = await fetch('/chatwoot/auto-create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                document.getElementById('cw_inbox_id').value = data.inbox_id;
                $('#successMessage').html(`<div class="header">Sucesso!</div><p>${data.message}</p>`);
                form.addClass('success');
                localStorage.setItem('wuzapi_admin_token', adminToken);
            } else {
                $('#errorMessage').text(data.error || "Erro desconhecido");
                form.addClass('error');
            }
        } catch (e) {
            $('#errorMessage').text("Erro de conexão com o servidor.");
            form.addClass('error');
        } finally {
            form.removeClass('loading');
        }
    }

    async function loadConfig() {
        const adminToken = document.getElementById('wuzapi_token').value;
        if(!adminToken) return;
        try {
            const res = await fetch('/chatwoot/config', { headers: { 'Authorization': adminToken } });
            if(res.ok) {
                const data = await res.json();
                document.getElementById('cw_url').value = data.url || '';
                document.getElementById('cw_token').value = data.token || '';
                document.getElementById('cw_account_id').value = data.account_id || '';
                document.getElementById('cw_inbox_id').value = data.inbox_id || '';
            }
        } catch(e){}
    }
    
    async function saveConfig() {
        // Lógica de salvamento manual simplificada (já implementada no autoCreate implicitamente ao salvar no disco)
        // Mas se quiser salvar sem criar:
        const adminToken = document.getElementById('wuzapi_token').value;
        const payload = {
            url: document.getElementById('cw_url').value,
            token: document.getElementById('cw_token').value,
            account_id: document.getElementById('cw_account_id').value,
            inbox_id: document.getElementById('cw_inbox_id').value
        };
        
        await fetch('/chatwoot/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
            body: JSON.stringify(payload)
        });
        alert("Salvo!");
    }
  </script>
</body>
</html>
